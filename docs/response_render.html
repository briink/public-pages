<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Briink EQA Custom Renderer</title>
        <style>
            :root {
                --bg-color: #1a1d21;
                --card-bg: #22262b;
                --text-color: #e8eaed;
                --text-muted: #9aa0a6;
                --border-color: #3c4043;
                --accent-color: #8ab4f8;
                --success-color: #81c995;
                --warning-color: #fdd663;
                --error-color: #f28b82;
                --diff-added-bg: rgba(129, 201, 149, 0.15);
                --diff-removed-bg: rgba(242, 139, 130, 0.15);
                --diff-added-text: #81c995;
                --diff-removed-text: #f28b82;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                background-color: var(--bg-color);
                color: var(--text-color);
                padding: 16px;
                line-height: 1.5;
            }

            .container {
                display: flex;
                flex-direction: column;
                gap: 24px;
                max-width: 1400px;
                margin: 0 auto;
            }

            .panel {
                background-color: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                overflow: hidden;
            }

            .panel-header {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 16px;
                background-color: #2d3136;
                border-bottom: 1px solid var(--border-color);
                font-weight: 600;
            }

            .panel-header .badge {
                font-size: 11px;
                padding: 2px 8px;
                border-radius: 12px;
                font-weight: 500;
            }

            .badge-output {
                background-color: var(--accent-color);
                color: #000;
            }

            .badge-reference {
                background-color: var(--success-color);
                color: #000;
            }

            .panel-content {
                padding: 16px;
            }

            .question-section {
                margin-bottom: 16px;
            }

            .question-label {
                font-size: 12px;
                text-transform: uppercase;
                color: var(--text-muted);
                margin-bottom: 4px;
                letter-spacing: 0.5px;
            }

            .question-text {
                font-size: 14px;
                color: var(--text-color);
            }

            .answer-section {
                background-color: #2d3136;
                border-radius: 6px;
                padding: 12px;
                margin-top: 12px;
            }

            .response-text {
                font-size: 14px;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .choices-list {
                margin-top: 8px;
            }

            .choice-item {
                display: flex;
                align-items: flex-start;
                gap: 8px;
                padding: 8px;
                border-radius: 4px;
                margin-bottom: 4px;
            }

            .choice-item.selected {
                background-color: rgba(74, 222, 128, 0.1);
                border-left: 3px solid var(--success-color);
            }

            .choice-item.not-selected {
                opacity: 0.6;
            }

            .choice-indicator {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                flex-shrink: 0;
            }

            .choice-indicator.selected {
                background-color: var(--success-color);
                color: #000;
            }

            .choice-indicator.not-selected {
                background-color: var(--border-color);
                color: var(--text-muted);
            }

            .choice-content {
                flex: 1;
            }

            .choice-label {
                font-weight: 500;
                font-size: 13px;
            }

            .choice-reasoning {
                font-size: 12px;
                color: var(--text-muted);
                margin-top: 4px;
            }

            .table-container {
                overflow-x: auto;
                margin-top: 12px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }

            th,
            td {
                padding: 10px 12px;
                text-align: left;
                border: 1px solid var(--border-color);
            }

            th {
                background-color: #2d3136;
                font-weight: 600;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                color: var(--accent-color);
            }

            td {
                background-color: #22262b;
            }

            .diff-legend {
                display: flex;
                gap: 16px;
                font-size: 12px;
                margin-bottom: 12px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .legend-color {
                width: 12px;
                height: 12px;
                border-radius: 2px;
            }

            .legend-color.match {
                background-color: var(--success-color);
            }

            .legend-color.diff {
                background-color: var(--error-color);
            }

            .legend-color.missing {
                background-color: var(--warning-color);
            }

            .diff-table td.match {
                background-color: rgba(74, 222, 128, 0.1);
            }

            .diff-table td.diff {
                background-color: var(--diff-removed-bg);
            }

            .diff-table td.missing {
                background-color: rgba(251, 191, 36, 0.1);
            }

            .diff-table td.extra {
                background-color: rgba(76, 201, 240, 0.1);
            }

            .cell-comparison {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .cell-output {
                color: var(--text-color);
            }

            .cell-reference {
                font-size: 11px;
                color: var(--text-muted);
                padding-top: 4px;
                border-top: 1px dashed var(--border-color);
            }

            .cell-reference::before {
                content: "Expected: ";
                color: var(--warning-color);
                font-weight: 500;
            }

            .stats-summary {
                display: flex;
                gap: 24px;
                padding: 12px 16px;
                background-color: #2d3136;
                border-radius: 6px;
                margin-bottom: 16px;
            }

            .stat-item {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .stat-value {
                font-size: 24px;
                font-weight: 700;
            }

            .stat-value.good {
                color: var(--success-color);
            }
            .stat-value.bad {
                color: var(--error-color);
            }
            .stat-value.neutral {
                color: var(--warning-color);
            }

            .stat-label {
                font-size: 11px;
                text-transform: uppercase;
                color: var(--text-muted);
                letter-spacing: 0.5px;
            }

            .side-by-side {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            @media (max-width: 900px) {
                .side-by-side {
                    grid-template-columns: 1fr;
                }
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
            }

            .metadata-section {
                margin-top: 16px;
                padding-top: 12px;
                border-top: 1px solid var(--border-color);
            }

            .metadata-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 8px;
            }

            .metadata-item {
                font-size: 12px;
            }

            .metadata-key {
                color: var(--text-muted);
            }

            .metadata-value {
                color: var(--text-color);
                font-family: monospace;
            }

            .json-fallback {
                background-color: #2d3136;
                border-radius: 6px;
                padding: 12px;
                overflow-x: auto;
            }

            .json-fallback pre {
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 12px;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .debug-panel {
                border: 2px solid #f0f !important;
            }

            .reasoning-table th {
                background-color: rgba(139, 92, 246, 0.25);
                color: #c4b5fd;
            }

            .reasoning-table td {
                background-color: rgba(139, 92, 246, 0.08);
                font-size: 12px;
                line-height: 1.4;
            }

            .table-section-label {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                margin-bottom: 8px;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .table-section-label.values {
                background-color: rgba(138, 180, 248, 0.2);
                color: #8ab4f8;
            }

            .table-section-label.reasoning {
                background-color: rgba(139, 92, 246, 0.2);
                color: #c4b5fd;
            }

            /* Tabs */
            .tabs {
                display: flex;
                gap: 0;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 0;
            }

            .tab {
                padding: 10px 20px;
                background: none;
                border: none;
                border-bottom: 2px solid transparent;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                color: var(--text-muted);
                transition: all 0.2s;
            }

            .tab:hover {
                color: var(--text-color);
                background-color: #2d3136;
            }

            .tab.active {
                color: var(--accent-color);
                border-bottom-color: var(--accent-color);
            }

            .tab-count {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 18px;
                height: 18px;
                padding: 0 5px;
                margin-left: 6px;
                background-color: #3c4043;
                border-radius: 9px;
                font-size: 11px;
                font-weight: 600;
                color: var(--text-muted);
            }

            .tab.active .tab-count {
                background-color: rgba(138, 180, 248, 0.2);
                color: var(--accent-color);
            }

            .tab-content {
                display: none;
                padding: 16px;
            }

            .tab-content.active {
                display: block;
            }

            /* Source Documents */
            .source-doc {
                border: 1px solid var(--border-color);
                border-radius: 6px;
                margin-bottom: 12px;
                overflow: hidden;
            }

            .source-doc:last-child {
                margin-bottom: 0;
            }

            .source-doc-header {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 14px;
                background-color: #2d3136;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
            }

            .source-doc-header:hover {
                background-color: #363b41;
            }

            .source-doc-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(138, 180, 248, 0.2);
                border-radius: 6px;
                color: var(--accent-color);
                font-size: 14px;
            }

            .source-doc-meta {
                flex: 1;
                min-width: 0;
            }

            .source-doc-filename {
                font-weight: 600;
                font-size: 13px;
                color: var(--text-color);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .source-doc-details {
                display: flex;
                flex-wrap: wrap;
                gap: 8px 16px;
                font-size: 11px;
                color: var(--text-muted);
                margin-top: 4px;
            }

            .source-doc-detail {
                display: flex;
                align-items: center;
                gap: 4px;
                word-break: break-all;
            }

            .source-doc-toggle {
                color: var(--text-muted);
                font-size: 12px;
                transition: transform 0.2s;
            }

            .source-doc.expanded .source-doc-toggle {
                transform: rotate(180deg);
            }

            .source-doc-content {
                display: none;
                padding: 14px;
                background-color: #22262b;
                font-size: 13px;
                line-height: 1.6;
                white-space: pre-wrap;
                word-wrap: break-word;
                max-height: 300px;
                overflow-y: auto;
            }

            .source-doc.expanded .source-doc-content {
                display: block;
            }

            .no-sources {
                text-align: center;
                padding: 40px 20px;
                color: var(--text-muted);
                font-size: 13px;
            }

            /* Stacked layout for tables */
            .tables-stacked {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            /* Inline reference bubbles */
            .ref-bubble {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 18px;
                height: 18px;
                padding: 0 5px;
                margin: 0 2px;
                background-color: var(--accent-color);
                color: #1a1d21;
                border-radius: 9px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.15s ease;
                vertical-align: middle;
            }

            .ref-bubble:hover {
                background-color: #a8c7fa;
                transform: scale(1.1);
            }

            .ref-bubble.invalid {
                background-color: var(--error-color);
                color: #1a1d21;
            }

            .ref-bubble.invalid:hover {
                background-color: #f5a9a3;
            }

            /* Source document index badge */
            .source-doc-index {
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 28px;
                height: 28px;
                padding: 0 8px;
                background-color: var(--accent-color);
                color: #1a1d21;
                border-radius: 14px;
                font-size: 12px;
                font-weight: 700;
                flex-shrink: 0;
            }

            /* Highlighted source when navigated to */
            .source-doc.highlighted {
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.3);
            }

            .source-doc.highlighted .source-doc-header {
                background-color: rgba(138, 180, 248, 0.15);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="content">
                <div class="loading">Waiting for data from LangSmith...</div>
            </div>
            <div id="debug-container" style="display: none"></div>
        </div>

        <button
            id="debug-toggle"
            style="
                position: fixed;
                bottom: 10px;
                right: 10px;
                padding: 8px 12px;
                background: #2d3136;
                color: #9aa0a6;
                border: 1px solid #3c4043;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                z-index: 1000;
            "
        >
            Show Debug
        </button>

        <script>
            // Debug toggle functionality
            let debugVisible = false;
            document
                .getElementById("debug-toggle")
                .addEventListener("click", function () {
                    debugVisible = !debugVisible;
                    const debugContainer =
                        document.getElementById("debug-container");
                    debugContainer.style.display = debugVisible
                        ? "block"
                        : "none";
                    this.textContent = debugVisible
                        ? "Hide Debug"
                        : "Show Debug";
                    this.style.background = debugVisible
                        ? "#4a235a"
                        : "#2d3136";
                });

            // Store received data
            let outputData = null;
            let referenceData = null;
            let metadata = null;
            let rawMessage = null;

            // Unwrap data if nested in an "output" key
            function unwrapData(data) {
                if (!data || typeof data !== "object") return data;

                // If data has an "output" key and it looks like the actual payload, unwrap it
                if (data.output && typeof data.output === "object") {
                    const nested = data.output;
                    const isTableResponse =
                        "column_headers" in nested ||
                        "rows" in nested ||
                        "reasoning" in nested ||
                        "question_text" in nested ||
                        "table_question_id" in nested;
                    const isEQAAnswer =
                        "response_text" in nested ||
                        "choices" in nested ||
                        "response_objects" in nested;

                    if (isTableResponse || isEQAAnswer) {
                        return nested;
                    }
                }

                return data;
            }

            // Listen for messages from LangSmith
            window.addEventListener("message", (event) => {
                const message = event.data;

                if (!message || typeof message !== "object") return;

                rawMessage = message;

                if (message.type === "output") {
                    outputData = unwrapData(message.data);
                    metadata = message.metadata;
                } else if (message.type === "reference") {
                    referenceData = unwrapData(message.data);
                }

                renderContent();
            });

            function renderContent() {
                const contentContainer = document.getElementById("content");
                const debugContainer =
                    document.getElementById("debug-container");

                if (!outputData && !referenceData) {
                    return;
                }

                const dataType = detectDataType(outputData || referenceData);

                // Render main content
                let contentHtml = "";
                switch (dataType) {
                    case "table_response":
                        contentHtml = renderTableResponse(
                            outputData,
                            referenceData,
                            metadata,
                        );
                        break;
                    case "eqa_answer":
                        contentHtml = renderEQAAnswer(
                            outputData,
                            referenceData,
                            metadata,
                        );
                        break;
                    default:
                        contentHtml = renderGenericJson(
                            outputData,
                            referenceData,
                            metadata,
                        );
                }
                contentContainer.innerHTML = contentHtml;

                // Render debug panel
                debugContainer.innerHTML = `
                    <div class="panel debug-panel">
                        <div class="panel-header">
                            <span>DEBUG INFO</span>
                        </div>
                        <div class="panel-content">
                            <div><strong>Detected Type:</strong> ${dataType}</div>
                            <div><strong>Has outputData:</strong> ${!!outputData}</div>
                            <div><strong>Has referenceData:</strong> ${!!referenceData}</div>
                            <div><strong>outputData keys:</strong> ${outputData ? Object.keys(outputData).join(", ") : "N/A"}</div>
                            <div><strong>"column_headers" in outputData:</strong> ${outputData ? "column_headers" in outputData : "N/A"}</div>
                            <div><strong>"rows" in outputData:</strong> ${outputData ? "rows" in outputData : "N/A"}</div>
                            <div style="margin-top: 10px;"><strong>Raw message.data:</strong></div>
                            <pre style="font-size: 11px; max-height: 150px; overflow: auto; background: #1a1d21; padding: 8px; border-radius: 4px;">${escapeHtml(JSON.stringify(rawMessage?.data, null, 2))}</pre>
                            <div style="margin-top: 10px;"><strong>Unwrapped outputData:</strong></div>
                            <pre style="font-size: 11px; max-height: 150px; overflow: auto; background: #1a1d21; padding: 8px; border-radius: 4px;">${escapeHtml(JSON.stringify(outputData, null, 2))}</pre>
                        </div>
                    </div>
                `;
            }

            function detectDataType(data) {
                if (!data) return "unknown";

                if (
                    "column_headers" in data ||
                    ("rows" in data && Array.isArray(data.rows)) ||
                    ("reasoning" in data && Array.isArray(data.reasoning))
                ) {
                    return "table_response";
                }

                if (
                    "response_text" in data ||
                    ("choices" in data && Array.isArray(data.choices)) ||
                    "response_objects" in data
                ) {
                    return "eqa_answer";
                }

                return "unknown";
            }

            function renderTableResponse(output, reference, meta) {
                let html = "";

                if (meta?.inputs?.question || meta?.inputs?.table_question) {
                    const question =
                        meta.inputs.table_question || meta.inputs.question;
                    html += `
                    <div class="panel">
                        <div class="panel-header"><span>Question</span></div>
                        <div class="panel-content">
                            <div class="question-text">${escapeHtml(question.text || question.parent_question?.text || JSON.stringify(question))}</div>
                            ${question.cell_questions ? renderColumnQuestions(question.cell_questions) : ""}
                        </div>
                    </div>
                `;
                }

                if (output && reference) {
                    html += renderTableDiff(output, reference);
                } else if (output) {
                    html += renderSingleTable(output, "Output", "output");
                } else if (reference) {
                    html += renderSingleTable(
                        reference,
                        "Reference",
                        "reference",
                    );
                }

                return html;
            }

            function renderColumnQuestions(cellQuestions) {
                if (!cellQuestions || cellQuestions.length === 0) return "";
                let html =
                    '<div class="metadata-section"><div class="question-label">Column Definitions</div><div class="choices-list">';
                cellQuestions.forEach((q, idx) => {
                    html += `
                    <div class="choice-item">
                        <div class="choice-indicator not-selected">${idx}</div>
                        <div class="choice-content">
                            <div class="choice-label">${escapeHtml(q.text || "")}</div>
                            ${q.data_type ? `<div class="choice-reasoning">Type: ${escapeHtml(q.data_type)}</div>` : ""}
                        </div>
                    </div>
                `;
                });
                html += "</div></div>";
                return html;
            }

            function renderTableDiff(output, reference) {
                const stats = calculateTableDiffStats(output, reference);
                const hasReasoning =
                    hasReasoningData(output) || hasReasoningData(reference);
                const sourceDocuments = getSourceDocuments(output, reference);

                return `
                <div class="panel">
                    <div class="panel-header">
                        <span>Table Comparison</span>
                        <span class="badge badge-output">Output vs Reference</span>
                    </div>
                    <div class="tabs">
                        <button class="tab active" data-tab="answers">Answers</button>
                        <button class="tab" data-tab="sources">Sources<span class="tab-count">${sourceDocuments.length}</span></button>
                    </div>
                    <div class="tab-content active" data-tab-content="answers">
                        <div class="stats-summary">
                            <div class="stat-item">
                                <span class="stat-value good">${stats.matchingCells}</span>
                                <span class="stat-label">Matching</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value bad">${stats.differentCells}</span>
                                <span class="stat-label">Different</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value neutral">${stats.missingCells}</span>
                                <span class="stat-label">Missing</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value neutral">${stats.extraCells}</span>
                                <span class="stat-label">Extra</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value ${stats.accuracy >= 80 ? "good" : stats.accuracy >= 50 ? "neutral" : "bad"}">${stats.accuracy.toFixed(1)}%</span>
                                <span class="stat-label">Accuracy</span>
                            </div>
                        </div>
                        <div class="diff-legend">
                            <div class="legend-item"><div class="legend-color match"></div> Match</div>
                            <div class="legend-item"><div class="legend-color diff"></div> Different</div>
                            <div class="legend-item"><div class="legend-color missing"></div> Missing/Extra</div>
                        </div>
                        <div class="tables-stacked">
                            <div>
                                <div class="table-section-label values">Values</div>
                                <div class="table-container">${renderValuesTable(output, reference, sourceDocuments.length)}</div>
                            </div>
                            ${
                                hasReasoning
                                    ? `
                            <div>
                                <div class="table-section-label reasoning">Reasoning</div>
                                <div class="table-container">${renderReasoningTable(output, reference, sourceDocuments.length)}</div>
                            </div>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                    <div class="tab-content" data-tab-content="sources">
                        ${renderSourceDocuments(sourceDocuments)}
                    </div>
                </div>
            `;
            }

            function calculateTableDiffStats(output, reference) {
                let matchingCells = 0,
                    differentCells = 0,
                    missingCells = 0,
                    extraCells = 0;

                const outputRows = output.rows || [];
                const refRows = reference.rows || [];
                const maxRows = Math.max(outputRows.length, refRows.length);
                const maxCols = Math.max(
                    output.column_headers?.length || 0,
                    reference.column_headers?.length || 0,
                );

                for (let i = 0; i < maxRows; i++) {
                    const outRow = outputRows[i] || [];
                    const refRow = refRows[i] || [];

                    for (let j = 0; j < maxCols; j++) {
                        const outCell = outRow[j];
                        const refCell = refRow[j];

                        if (outCell === undefined && refCell !== undefined)
                            missingCells++;
                        else if (outCell !== undefined && refCell === undefined)
                            extraCells++;
                        else if (
                            normalizeValue(outCell) === normalizeValue(refCell)
                        )
                            matchingCells++;
                        else differentCells++;
                    }
                }

                const totalComparable = matchingCells + differentCells;
                const accuracy =
                    totalComparable > 0
                        ? (matchingCells / totalComparable) * 100
                        : 0;

                return {
                    matchingCells,
                    differentCells,
                    missingCells,
                    extraCells,
                    accuracy,
                };
            }

            function normalizeValue(val) {
                if (val === null || val === undefined) return "";
                return String(val).trim().toLowerCase();
            }

            function hasReasoningData(data) {
                if (!data || !data.reasoning) return false;
                const rows = data.reasoning || [];
                // Show reasoning table if the field exists and is an array with rows
                return Array.isArray(rows) && rows.length > 0;
            }

            function getSourceDocuments(output, reference) {
                const outputDocs = output?.source_documents || [];
                const refDocs = reference?.source_documents || [];
                // Combine and deduplicate by some identifier if needed
                return [...outputDocs, ...refDocs];
            }

            function renderSourceDocuments(documents) {
                if (!documents || documents.length === 0) {
                    return '<div class="no-sources">No source documents available</div>';
                }

                return documents
                    .map((doc, index) => {
                        const metadata = doc.metadata || {};
                        const pageContent = doc.page_content || "";
                        const fileName =
                            metadata.file_name ||
                            metadata.filename ||
                            metadata.source ||
                            "Unknown file";
                        const pageNumber =
                            metadata.page_number ||
                            metadata.page ||
                            metadata.page_idx ||
                            "-";
                        const fileId =
                            metadata.file_id ||
                            metadata.id ||
                            metadata.chunk_uuid ||
                            "";

                        return `
                        <div class="source-doc" data-doc-index="${index}" id="source-doc-${index}">
                            <div class="source-doc-header" onclick="toggleSourceDoc(${index})">
                                <div class="source-doc-index">${index}</div>
                                <div class="source-doc-meta">
                                    <div class="source-doc-filename">${escapeHtml(fileName)}</div>
                                    <div class="source-doc-details">
                                        <span class="source-doc-detail">Page: ${escapeHtml(String(pageNumber))}</span>
                                        ${fileId ? `<span class="source-doc-detail">ID: ${escapeHtml(fileId)}</span>` : ""}
                                    </div>
                                </div>
                                <span class="source-doc-toggle">&#9660;</span>
                            </div>
                            <div class="source-doc-content">${escapeHtml(pageContent)}</div>
                        </div>
                    `;
                    })
                    .join("");
            }

            function toggleSourceDoc(index) {
                const doc = document.querySelector(
                    `.source-doc[data-doc-index="${index}"]`,
                );
                if (doc) {
                    doc.classList.toggle("expanded");
                }
            }

            // Store source document count for validation
            let currentSourceCount = 0;

            function processInlineReferences(text, sourceCount) {
                if (!text) return "";
                currentSourceCount = sourceCount;

                // First escape HTML
                const div = document.createElement("div");
                div.textContent = String(text);
                let escaped = div.innerHTML;

                // Then replace [^N^] patterns with clickable bubbles
                escaped = escaped.replace(/\[\^(\d+)\^\]/g, (match, num) => {
                    const index = parseInt(num, 10);
                    const isValid = index >= 0 && index < sourceCount;
                    const className = isValid
                        ? "ref-bubble"
                        : "ref-bubble invalid";
                    return `<span class="${className}" onclick="navigateToSource(${index}, ${sourceCount})" title="${isValid ? "Go to source " + index : "Invalid reference (out of bounds)"}">${index}</span>`;
                });

                return escaped;
            }

            function navigateToSource(index, sourceCount) {
                // Check if index is valid
                if (index < 0 || index >= sourceCount) {
                    console.warn("Invalid source reference:", index);
                    return;
                }

                // Find the panel containing the clicked reference
                const panel = event.target.closest(".panel");
                if (!panel) return;

                // Switch to sources tab
                const sourcesTab = panel.querySelector('[data-tab="sources"]');
                if (sourcesTab) {
                    sourcesTab.click();
                }

                // Wait a bit for tab switch, then scroll to and highlight the source
                setTimeout(() => {
                    const sourceDoc = panel.querySelector(
                        `#source-doc-${index}`,
                    );
                    if (sourceDoc) {
                        // Remove previous highlights
                        panel
                            .querySelectorAll(".source-doc.highlighted")
                            .forEach((el) => {
                                el.classList.remove("highlighted");
                            });

                        // Highlight and expand the target
                        sourceDoc.classList.add("highlighted");
                        sourceDoc.classList.add("expanded");

                        // Scroll into view
                        sourceDoc.scrollIntoView({
                            behavior: "smooth",
                            block: "center",
                        });

                        // Remove highlight after a delay
                        setTimeout(() => {
                            sourceDoc.classList.remove("highlighted");
                        }, 3000);
                    }
                }, 100);
            }

            function renderValuesTable(output, reference, sourceCount) {
                const outputHeaders = output.column_headers || [];
                const refHeaders = reference.column_headers || [];
                const headers =
                    outputHeaders.length >= refHeaders.length
                        ? outputHeaders
                        : refHeaders;

                const outputRows = output.rows || [];
                const refRows = reference.rows || [];
                const maxRows = Math.max(outputRows.length, refRows.length);
                const srcCount = sourceCount || 0;

                let html = '<table class="diff-table"><thead><tr><th>#</th>';
                headers.forEach((h) => {
                    html += `<th>${escapeHtml(h)}</th>`;
                });
                html += "</tr></thead><tbody>";

                for (let i = 0; i < maxRows; i++) {
                    const outRow = outputRows[i] || [];
                    const refRow = refRows[i] || [];
                    html += `<tr><td>${i + 1}</td>`;

                    for (let j = 0; j < headers.length; j++) {
                        const outCell = outRow[j];
                        const refCell = refRow[j];
                        const cellClass = getCellDiffClass(outCell, refCell);

                        html += `<td class="${cellClass}">`;
                        if (cellClass === "match") {
                            html += `<span class="cell-output">${processInlineReferences(outCell || "", srcCount)}</span>`;
                        } else if (cellClass === "diff") {
                            html += `<div class="cell-comparison"><span class="cell-output">${processInlineReferences(outCell || "", srcCount)}</span><span class="cell-reference">${processInlineReferences(refCell || "", srcCount)}</span></div>`;
                        } else if (cellClass === "missing") {
                            html += `<span class="cell-reference">${processInlineReferences(refCell || "", srcCount)}</span>`;
                        } else {
                            html += `<span class="cell-output">${processInlineReferences(outCell || "", srcCount)}</span>`;
                        }
                        html += "</td>";
                    }
                    html += "</tr>";
                }

                html += "</tbody></table>";
                return html;
            }

            function getCellDiffClass(outCell, refCell) {
                if (outCell === undefined && refCell !== undefined)
                    return "missing";
                if (outCell !== undefined && refCell === undefined)
                    return "extra";
                if (normalizeValue(outCell) === normalizeValue(refCell))
                    return "match";
                return "diff";
            }

            function renderReasoningTable(output, reference, sourceCount) {
                const outputHeaders = output.column_headers || [];
                const refHeaders = reference.column_headers || [];
                const headers =
                    outputHeaders.length >= refHeaders.length
                        ? outputHeaders
                        : refHeaders;

                const outputReasoningRows = output.reasoning || [];
                const refReasoningRows = reference.reasoning || [];
                const maxRows = Math.max(
                    outputReasoningRows.length,
                    refReasoningRows.length,
                );
                const srcCount = sourceCount || 0;

                let html =
                    '<table class="diff-table reasoning-table"><thead><tr><th>#</th>';
                headers.forEach((h) => {
                    html += `<th>${escapeHtml(h)}</th>`;
                });
                html += "</tr></thead><tbody>";

                for (let i = 0; i < maxRows; i++) {
                    const outRow = outputReasoningRows[i] || [];
                    const refRow = refReasoningRows[i] || [];
                    html += `<tr><td>${i + 1}</td>`;

                    for (let j = 0; j < headers.length; j++) {
                        const outReasoning = outRow[j];
                        const refReasoning = refRow[j];

                        // Use same cell values to determine diff class
                        const outputRows = output.rows || [];
                        const refRows = reference.rows || [];
                        const outCell = outputRows[i]
                            ? outputRows[i][j]
                            : undefined;
                        const refCell = refRows[i] ? refRows[i][j] : undefined;
                        const cellClass = getCellDiffClass(outCell, refCell);

                        html += `<td class="${cellClass}">`;
                        if (cellClass === "match" || cellClass === "diff") {
                            if (outReasoning) {
                                html += `<div class="cell-comparison"><span class="cell-output">${processInlineReferences(outReasoning, srcCount)}</span>`;
                                if (
                                    cellClass === "diff" &&
                                    refReasoning &&
                                    refReasoning !== outReasoning
                                ) {
                                    html += `<span class="cell-reference">${processInlineReferences(refReasoning, srcCount)}</span>`;
                                }
                                html += `</div>`;
                            } else {
                                html += `<span class="cell-output" style="color: var(--text-muted); font-style: italic;">No reasoning</span>`;
                            }
                        } else if (cellClass === "missing") {
                            html += `<span class="cell-reference">${processInlineReferences(refReasoning || "", srcCount)}</span>`;
                        } else {
                            html += `<span class="cell-output">${processInlineReferences(outReasoning || "", srcCount)}</span>`;
                        }
                        html += "</td>";
                    }
                    html += "</tr>";
                }

                html += "</tbody></table>";
                return html;
            }

            function renderSingleTable(data, title, type) {
                const badgeClass =
                    type === "output" ? "badge-output" : "badge-reference";
                const hasReasoning = hasReasoningData(data);
                const sourceDocuments = data.source_documents || [];
                const srcCount = sourceDocuments.length;

                let valuesTable = `
                    <table>
                        <thead><tr><th>#</th>${(data.column_headers || []).map((h) => `<th>${escapeHtml(h)}</th>`).join("")}</tr></thead>
                        <tbody>${(data.rows || []).map((row, i) => `<tr><td>${i + 1}</td>${row.map((cell) => `<td>${processInlineReferences(cell || "", srcCount)}</td>`).join("")}</tr>`).join("")}</tbody>
                    </table>
                `;

                let reasoningTable = "";
                if (hasReasoning) {
                    const reasoningRows = data.reasoning || [];
                    reasoningTable = `
                        <table class="reasoning-table">
                            <thead><tr><th>#</th>${(data.column_headers || []).map((h) => `<th>${escapeHtml(h)}</th>`).join("")}</tr></thead>
                            <tbody>${reasoningRows.map((row, i) => `<tr><td>${i + 1}</td>${row.map((cell) => `<td>${processInlineReferences(cell || "", srcCount)}</td>`).join("")}</tr>`).join("")}</tbody>
                        </table>
                    `;
                }

                return `
                <div class="panel">
                    <div class="panel-header">
                        <span>Table ${title}</span>
                        <span class="badge ${badgeClass}">${type}</span>
                    </div>
                    <div class="tabs">
                        <button class="tab active" data-tab="answers">Answers</button>
                        <button class="tab" data-tab="sources">Sources<span class="tab-count">${sourceDocuments.length}</span></button>
                    </div>
                    <div class="tab-content active" data-tab-content="answers">
                        ${data.question_text ? `<div class="question-section"><div class="question-label">Question</div><div class="question-text">${escapeHtml(data.question_text)}</div></div>` : ""}
                        <div class="tables-stacked">
                            <div>
                                <div class="table-section-label values">Values</div>
                                <div class="table-container">${valuesTable}</div>
                            </div>
                            ${
                                hasReasoning
                                    ? `
                            <div>
                                <div class="table-section-label reasoning">Reasoning</div>
                                <div class="table-container">${reasoningTable}</div>
                            </div>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                    <div class="tab-content" data-tab-content="sources">
                        ${renderSourceDocuments(sourceDocuments)}
                    </div>
                </div>
            `;
            }

            function renderEQAAnswer(output, reference, meta) {
                let html = "";

                if (meta?.inputs?.question) {
                    const question = meta.inputs.question;
                    html += `
                    <div class="panel">
                        <div class="panel-header">
                            <span>Question</span>
                            ${question.data_type ? `<span class="badge badge-output">${escapeHtml(question.data_type)}</span>` : ""}
                        </div>
                        <div class="panel-content">
                            <div class="question-text">${escapeHtml(question.text || "")}</div>
                            ${question.choices && question.choices.length > 0 ? renderQuestionChoices(question.choices) : ""}
                        </div>
                    </div>
                `;
                }

                if (output && reference) {
                    html += `<div class="side-by-side">`;
                    html += renderSingleEQAAnswer(output, "Output", "output");
                    html += renderSingleEQAAnswer(
                        reference,
                        "Reference",
                        "reference",
                    );
                    html += `</div>`;
                    html += renderEQAComparison(output, reference);
                } else if (output) {
                    html += renderSingleEQAAnswer(output, "Output", "output");
                } else if (reference) {
                    html += renderSingleEQAAnswer(
                        reference,
                        "Reference",
                        "reference",
                    );
                }

                return html;
            }

            function renderQuestionChoices(choices) {
                let html =
                    '<div class="metadata-section"><div class="question-label">Available Choices</div><div class="choices-list">';
                choices.forEach((choice) => {
                    html += `
                    <div class="choice-item">
                        <div class="choice-content">
                            <div class="choice-label">${escapeHtml(choice.label || "")}</div>
                            ${choice.description ? `<div class="choice-reasoning">${escapeHtml(choice.description)}</div>` : ""}
                        </div>
                    </div>
                `;
                });
                html += "</div></div>";
                return html;
            }

            function renderSingleEQAAnswer(data, title, type) {
                const badgeClass =
                    type === "output" ? "badge-output" : "badge-reference";

                let html = `
                <div class="panel">
                    <div class="panel-header">
                        <span>${title}</span>
                        <span class="badge ${badgeClass}">${type}</span>
                    </div>
                    <div class="panel-content">
            `;

                if (data.response_text) {
                    html += `<div class="answer-section"><div class="question-label">Response</div><div class="response-text">${escapeHtml(data.response_text)}</div></div>`;
                }

                if (data.reasoning) {
                    html += `<div class="answer-section"><div class="question-label">Reasoning</div><div class="response-text">${escapeHtml(data.reasoning)}</div></div>`;
                }

                if (data.choices && data.choices.length > 0) {
                    html += `<div class="answer-section"><div class="question-label">Choices</div><div class="choices-list">`;
                    data.choices.forEach((choice) => {
                        html += `
                        <div class="choice-item ${choice.is_selected ? "selected" : "not-selected"}">
                            <div class="choice-indicator ${choice.is_selected ? "selected" : "not-selected"}">${choice.is_selected ? "&#10003;" : ""}</div>
                            <div class="choice-content">
                                <div class="choice-label">${escapeHtml(choice.label || "")}</div>
                                ${choice.reasoning ? `<div class="choice-reasoning">${escapeHtml(choice.reasoning)}</div>` : ""}
                            </div>
                        </div>
                    `;
                    });
                    html += `</div></div>`;
                }

                if (
                    data.response_objects &&
                    Object.keys(data.response_objects).length > 0
                ) {
                    html += renderResponseObjects(data.response_objects);
                }

                html += `</div></div>`;
                return html;
            }

            function renderResponseObjects(responseObjects) {
                let html =
                    '<div class="answer-section"><div class="question-label">Additional Data</div>';

                if (responseObjects.metrics) {
                    const metrics = responseObjects.metrics;
                    html += `<div class="metadata-grid">`;
                    if (metrics.full_string_answers) {
                        html += `<div class="metadata-item"><span class="metadata-key">Answer: </span><span class="metadata-value">${escapeHtml(metrics.full_string_answers)}</span></div>`;
                    }
                    if (
                        metrics.structured_data &&
                        metrics.structured_data.length > 0
                    ) {
                        metrics.structured_data.forEach((m) => {
                            html += `<div class="metadata-item"><span class="metadata-key">${escapeHtml(m.metric_name)}: </span><span class="metadata-value">${m.value} ${escapeHtml(m.unit)} ${m.time_period ? `(${escapeHtml(m.time_period)})` : ""}</span></div>`;
                        });
                    }
                    html += `</div>`;
                }

                if (responseObjects.gap_analysis) {
                    const ga = responseObjects.gap_analysis;
                    html += `<div class="metadata-item"><span class="metadata-key">Gap Analysis: </span><span class="metadata-value">${escapeHtml(ga.tag)}</span></div>`;
                }

                if (responseObjects.scoring) {
                    const scoring = responseObjects.scoring;
                    html += `<div class="metadata-item"><span class="metadata-key">Score: </span><span class="metadata-value">${escapeHtml(scoring.score)}</span></div>`;
                }

                html += "</div>";
                return html;
            }

            function renderEQAComparison(output, reference) {
                const outputText = normalizeValue(output.response_text);
                const refText = normalizeValue(reference.response_text);
                const textMatch = outputText === refText;

                const outputChoices = new Set(
                    (output.choices || [])
                        .filter((c) => c.is_selected)
                        .map((c) => normalizeValue(c.label)),
                );
                const refChoices = new Set(
                    (reference.choices || [])
                        .filter((c) => c.is_selected)
                        .map((c) => normalizeValue(c.label)),
                );

                let choiceMatch = true;
                if (outputChoices.size > 0 || refChoices.size > 0) {
                    choiceMatch =
                        outputChoices.size === refChoices.size &&
                        [...outputChoices].every((c) => refChoices.has(c));
                }

                const overallMatch = textMatch && choiceMatch;

                return `
                <div class="panel">
                    <div class="panel-header">
                        <span>Comparison Summary</span>
                        <span class="badge ${overallMatch ? "badge-reference" : "badge-output"}">${overallMatch ? "Match" : "Mismatch"}</span>
                    </div>
                    <div class="panel-content">
                        <div class="stats-summary">
                            <div class="stat-item">
                                <span class="stat-value ${textMatch ? "good" : "bad"}">${textMatch ? "&#10003;" : "&#10007;"}</span>
                                <span class="stat-label">Response Text</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value ${choiceMatch ? "good" : "bad"}">${choiceMatch ? "&#10003;" : "&#10007;"}</span>
                                <span class="stat-label">Choices</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderGenericJson(output, reference, meta) {
                let html = "";

                if (output) {
                    html += `
                    <div class="panel">
                        <div class="panel-header"><span>Output</span><span class="badge badge-output">output</span></div>
                        <div class="panel-content">
                            <div class="json-fallback"><pre>${escapeHtml(JSON.stringify(output, null, 2))}</pre></div>
                        </div>
                    </div>
                `;
                }

                if (reference) {
                    html += `
                    <div class="panel">
                        <div class="panel-header"><span>Reference</span><span class="badge badge-reference">reference</span></div>
                        <div class="panel-content">
                            <div class="json-fallback"><pre>${escapeHtml(JSON.stringify(reference, null, 2))}</pre></div>
                        </div>
                    </div>
                `;
                }

                return html;
            }

            function escapeHtml(text) {
                if (text === null || text === undefined) return "";
                const div = document.createElement("div");
                div.textContent = String(text);
                return div.innerHTML;
            }

            // Tab switching - use event delegation
            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("tab")) {
                    const tab = e.target;
                    const tabName = tab.getAttribute("data-tab");
                    const panel = tab.closest(".panel");

                    // Update active tab
                    panel
                        .querySelectorAll(".tab")
                        .forEach((t) => t.classList.remove("active"));
                    tab.classList.add("active");

                    // Update active content
                    panel
                        .querySelectorAll(".tab-content")
                        .forEach((c) => c.classList.remove("active"));
                    panel
                        .querySelector(`[data-tab-content="${tabName}"]`)
                        .classList.add("active");
                }
            });
        </script>
    </body>
</html>
