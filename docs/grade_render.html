<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Briink Table Grade Result Renderer</title>
        <script src="https://cdn.jsdelivr.net/npm/renderjson@1.4.0/renderjson.min.js"></script>
        <style>
            :root {
                --bg-color: #1a1d21;
                --card-bg: #22262b;
                --text-color: #e8eaed;
                --text-muted: #9aa0a6;
                --border-color: #3c4043;
                --accent-color: #8ab4f8;

                /* Annotation category colors */
                --correct-color: #81c995;
                --correct-bg: rgba(129, 201, 149, 0.15);
                --format-color: #8ab4f8;
                --format-bg: rgba(138, 180, 248, 0.15);
                --useful-color: #fdd663;
                --useful-bg: rgba(253, 214, 99, 0.15);
                --not-found-color: #f9a825;
                --not-found-bg: rgba(249, 168, 37, 0.15);
                --missing-color: #f28b82;
                --missing-bg: rgba(242, 139, 130, 0.15);
                --not-match-color: #f28b82;
                --not-match-bg: rgba(242, 139, 130, 0.15);
                --reference-quality-color: #c4b5fd;
                --reference-quality-bg: rgba(196, 181, 253, 0.15);
                --table-issue-color: #f48fb1;
                --table-issue-bg: rgba(244, 143, 177, 0.15);
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                background-color: var(--bg-color);
                color: var(--text-color);
                padding: 16px;
                line-height: 1.5;
            }

            .container {
                display: flex;
                flex-direction: column;
                gap: 16px;
                width: 100%;
                max-width: 100%;
            }

            .panel {
                background-color: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                overflow: hidden;
            }

            .panel-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                padding: 12px 16px;
                background-color: #2d3136;
                border-bottom: 1px solid var(--border-color);
                font-weight: 600;
            }

            .panel-header-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .panel-content {
                padding: 16px;
            }

            /* Badges */
            .badge {
                font-size: 10px;
                padding: 2px 8px;
                border-radius: 10px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                cursor: default;
                position: relative;
            }

            .badge-large {
                font-size: 11px;
                padding: 3px 10px;
                border-radius: 12px;
            }

            .badge-correct {
                background-color: var(--correct-color);
                color: #000;
            }
            .badge-format {
                background-color: var(--format-color);
                color: #000;
            }
            .badge-useful {
                background-color: var(--useful-color);
                color: #000;
            }
            .badge-not-found {
                background-color: var(--not-found-color);
                color: #000;
            }
            .badge-missing {
                background-color: var(--missing-color);
                color: #000;
            }
            .badge-not-match {
                background-color: var(--not-match-color);
                color: #000;
            }
            .badge-reference-quality {
                background-color: var(--reference-quality-color);
                color: #000;
            }
            .badge-table-issue {
                background-color: var(--table-issue-color);
                color: #000;
            }

            /* Tooltip */
            .tooltip-container {
                position: relative;
                display: inline-block;
            }

            .tooltip {
                visibility: hidden;
                opacity: 0;
                position: absolute;
                bottom: calc(100% + 8px);
                left: 50%;
                transform: translateX(-50%);
                background-color: #1a1d21;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                padding: 10px 12px;
                width: 280px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                transition:
                    opacity 0.2s,
                    visibility 0.2s;
            }

            .tooltip::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 6px solid transparent;
                border-top-color: var(--border-color);
            }

            .tooltip-container:hover .tooltip {
                visibility: visible;
                opacity: 1;
            }

            .tooltip-subtype {
                font-family: monospace;
                font-size: 11px;
                color: var(--accent-color);
                margin-bottom: 6px;
            }

            .tooltip-rationale {
                font-size: 12px;
                color: var(--text-color);
                line-height: 1.4;
            }

            /* Stats Summary */
            .stats-summary {
                display: flex;
                flex-wrap: wrap;
                gap: 16px;
                padding: 16px;
                background-color: #2d3136;
                border-radius: 6px;
                margin-bottom: 16px;
            }

            .stat-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 80px;
            }

            .stat-value {
                font-size: 24px;
                font-weight: 700;
            }

            .stat-value.good {
                color: var(--correct-color);
            }
            .stat-value.warning {
                color: var(--useful-color);
            }
            .stat-value.bad {
                color: var(--not-match-color);
            }
            .stat-value.neutral {
                color: var(--text-muted);
            }

            .stat-label {
                font-size: 11px;
                text-transform: uppercase;
                color: var(--text-muted);
                letter-spacing: 0.5px;
                margin-top: 4px;
            }

            /* Tabs */
            .tabs {
                display: flex;
                gap: 0;
                border-bottom: 1px solid var(--border-color);
            }

            .tab {
                padding: 10px 20px;
                background: none;
                border: none;
                border-bottom: 2px solid transparent;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                color: var(--text-muted);
                transition: all 0.2s;
            }

            .tab:hover {
                color: var(--text-color);
                background-color: #2d3136;
            }

            .tab.active {
                color: var(--accent-color);
                border-bottom-color: var(--accent-color);
            }

            .tab-count {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 18px;
                height: 18px;
                padding: 0 5px;
                margin-left: 6px;
                background-color: #3c4043;
                border-radius: 9px;
                font-size: 11px;
                font-weight: 600;
                color: var(--text-muted);
            }

            .tab.active .tab-count {
                background-color: rgba(138, 180, 248, 0.2);
                color: var(--accent-color);
            }

            .tab-content {
                display: none;
                padding: 16px;
            }

            .tab-content.active {
                display: block;
            }

            /* Grade Table */
            .table-container {
                overflow-x: auto;
                width: 100%;
            }

            .grade-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }

            .grade-table th,
            .grade-table td {
                border: 1px solid var(--border-color);
                padding: 0;
                vertical-align: top;
            }

            .grade-table th {
                background-color: #2d3136;
                font-weight: 600;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                color: var(--accent-color);
                padding: 10px 12px;
                text-align: left;
            }

            .grade-table th.row-key-header {
                width: 150px;
                min-width: 150px;
            }

            /* Row key cell */
            .row-key-cell {
                background-color: #2d3136;
                padding: 10px 12px;
                font-weight: 600;
                font-size: 12px;
            }

            .row-key-name {
                color: var(--text-color);
                margin-bottom: 4px;
            }

            .row-key-meta {
                font-size: 10px;
                color: var(--text-muted);
                font-weight: 400;
            }

            /* Grade cell with split layout */
            .grade-cell {
                display: flex;
                flex-direction: column;
                min-height: 80px;
            }

            .grade-cell-values {
                display: flex;
                flex: 1;
            }

            .grade-cell-predicted,
            .grade-cell-gt {
                flex: 1;
                padding: 8px 10px;
                font-size: 12px;
                line-height: 1.4;
            }

            .grade-cell-predicted {
                background-color: rgba(138, 180, 248, 0.08);
                border-right: 1px dashed var(--border-color);
            }

            .grade-cell-gt {
                background-color: rgba(129, 201, 149, 0.08);
            }

            .grade-cell-label {
                font-size: 9px;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                margin-bottom: 4px;
                font-weight: 600;
            }

            .grade-cell-predicted .grade-cell-label {
                color: var(--accent-color);
            }

            .grade-cell-gt .grade-cell-label {
                color: var(--correct-color);
            }

            .grade-cell-value {
                color: var(--text-color);
                white-space: pre-wrap;
                word-break: break-word;
            }

            .grade-cell-badge {
                display: flex;
                justify-content: center;
                padding: 6px;
                border-bottom: 1px solid var(--border-color);
                background-color: #2d3136;
            }

            /* Cell background colors based on annotation */
            .grade-cell.cell-correct .grade-cell-badge {
                background-color: var(--correct-bg);
            }
            .grade-cell.cell-format .grade-cell-badge {
                background-color: var(--format-bg);
            }
            .grade-cell.cell-useful .grade-cell-badge {
                background-color: var(--useful-bg);
            }
            .grade-cell.cell-not-found .grade-cell-badge {
                background-color: var(--not-found-bg);
            }
            .grade-cell.cell-missing .grade-cell-badge {
                background-color: var(--missing-bg);
            }
            .grade-cell.cell-not-match .grade-cell-badge {
                background-color: var(--not-match-bg);
            }
            .grade-cell.cell-reference-quality .grade-cell-badge {
                background-color: var(--reference-quality-bg);
            }
            .grade-cell.cell-table-issue .grade-cell-badge {
                background-color: var(--table-issue-bg);
            }

            /* Evaluation Output (for issues) */
            .eval-output {
                border: 1px solid var(--border-color);
                border-radius: 6px;
                margin-bottom: 10px;
                overflow: hidden;
            }

            .eval-output:last-child {
                margin-bottom: 0;
            }

            .eval-output-header {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 12px;
                background-color: #2d3136;
                cursor: pointer;
            }

            .eval-output-header:hover {
                background-color: #363b41;
            }

            .eval-output-toggle {
                color: var(--text-muted);
                font-size: 10px;
                transition: transform 0.2s;
            }

            .eval-output.expanded .eval-output-toggle {
                transform: rotate(180deg);
            }

            .eval-output-content {
                display: none;
                padding: 12px;
                border-top: 1px solid var(--border-color);
            }

            .eval-output.expanded .eval-output-content {
                display: block;
            }

            .detail-label {
                font-size: 11px;
                text-transform: uppercase;
                color: var(--text-muted);
                margin-bottom: 4px;
                letter-spacing: 0.3px;
            }

            .detail-value.rationale {
                font-size: 13px;
                background-color: #1a1d21;
                padding: 10px;
                border-radius: 4px;
                border-left: 3px solid var(--accent-color);
                line-height: 1.5;
            }

            /* Missing/Extra Rows */
            .row-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .row-list-item {
                padding: 4px 10px;
                background-color: #2d3136;
                border-radius: 4px;
                font-size: 12px;
                border: 1px solid var(--border-color);
            }

            .row-list-item.missing {
                border-color: var(--not-found-color);
                color: var(--not-found-color);
            }

            .row-list-item.extra {
                border-color: var(--useful-color);
                color: var(--useful-color);
            }

            .row-list-section {
                margin-top: 16px;
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 32px 16px;
                color: var(--text-muted);
                font-size: 13px;
            }

            /* JSON Fallback - renderjson styling */
            .json-fallback {
                background-color: #2d3136;
                border-radius: 6px;
                padding: 12px;
                overflow-x: auto;
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 12px;
                line-height: 1.6;
            }

            /* renderjson overrides for dark theme */
            .json-fallback .renderjson a {
                text-decoration: none;
                color: var(--accent-color);
            }

            .json-fallback .renderjson a:hover {
                color: #a8c7fa;
            }

            .json-fallback .disclosure {
                color: var(--accent-color);
                font-weight: bold;
                cursor: pointer;
                padding: 0 4px;
            }

            .json-fallback .string {
                color: #f9a825; /* orange/amber for strings */
            }

            .json-fallback .number {
                color: #8ab4f8; /* blue for numbers */
            }

            .json-fallback .boolean {
                color: #c4b5fd; /* purple for booleans */
            }

            .json-fallback .key {
                color: #4fc3f7; /* cyan for keys */
            }

            .json-fallback .null {
                color: var(--text-muted);
            }

            .json-fallback .syntax {
                color: var(--text-color);
            }

            /* Loading */
            .loading {
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
            }

            /* Comment section */
            .comment-section {
                background-color: #2d3136;
                border-radius: 6px;
                padding: 12px;
                margin-top: 16px;
                font-size: 12px;
                color: var(--text-muted);
                white-space: pre-wrap;
                border-left: 3px solid var(--accent-color);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="content">
                <div class="loading">Waiting for data from LangSmith...</div>
            </div>
        </div>

        <script>
            let outputData = null;
            let referenceData = null;
            let metadata = null;

            window.addEventListener("message", (event) => {
                const message = event.data;
                if (!message || typeof message !== "object") return;

                if (message.type === "output") {
                    outputData = message.data;
                    metadata = message.metadata;
                } else if (message.type === "reference") {
                    referenceData = message.data;
                }

                renderContent();
            });

            function renderContent() {
                const contentContainer = document.getElementById("content");
                if (!outputData && !referenceData) return;

                const data = outputData || referenceData;

                if (isTableGradeResult(data)) {
                    contentContainer.innerHTML = renderTableGradeResult(data);
                    attachEventListeners();
                } else {
                    contentContainer.innerHTML = renderJsonFallback(data);
                }
            }

            function isTableGradeResult(data) {
                if (!data || typeof data !== "object") return false;
                return "row_grades" in data && "accuracy_score" in data;
            }

            function renderTableGradeResult(data) {
                const annotation = data.annotation || "UNKNOWN";
                const badgeClass = getAnnotationBadgeClass(annotation);
                const accuracyScore = data.accuracy_score ?? 0;
                const structureScore = data.structure_score ?? 1.0;
                const refDataScore = data.reference_data_score ?? 1.0;
                const missingRows = data.missing_rows || [];
                const extraRows = data.extra_rows || [];
                const rowGrades = data.row_grades || [];
                const structureIssues = data.structure_issues || [];
                const refDataIssues = data.reference_data_issues || [];

                return `
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-header-left">
                                <span>Table Grade Result</span>
                                ${data.table_question_id ? `<span style="font-size: 11px; color: var(--text-muted);">${escapeHtml(data.table_question_id)}</span>` : ""}
                            </div>
                            <span class="badge badge-large ${badgeClass}">${escapeHtml(annotation)}</span>
                        </div>

                        <div class="panel-content">
                            ${renderStatsSummary(accuracyScore, structureScore, refDataScore, missingRows.length, extraRows.length)}
                        </div>

                        <div class="tabs">
                            <button class="tab active" data-tab="grades">Cell Grades</button>
                            <button class="tab" data-tab="structure">Structure Issues<span class="tab-count">${structureIssues.length}</span></button>
                            <button class="tab" data-tab="reference">Reference Issues<span class="tab-count">${refDataIssues.length}</span></button>
                        </div>

                        <div class="tab-content active" data-tab-content="grades">
                            ${renderGradeTable(rowGrades)}
                            ${renderMissingExtraRows(missingRows, extraRows)}
                        </div>

                        <div class="tab-content" data-tab-content="structure">
                            ${renderEvaluationOutputs(structureIssues, "No structure issues detected")}
                        </div>

                        <div class="tab-content" data-tab-content="reference">
                            ${renderEvaluationOutputs(refDataIssues, "No reference data issues detected")}
                        </div>

                        ${data.comment ? `<div class="panel-content"><div class="comment-section">${escapeHtml(data.comment)}</div></div>` : ""}
                    </div>
                `;
            }

            function renderStatsSummary(
                accuracy,
                structure,
                refData,
                missing,
                extra,
            ) {
                return `
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-value ${getScoreClass(accuracy)}">${(accuracy * 100).toFixed(1)}%</span>
                            <span class="stat-label">Accuracy</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value ${getScoreClass(structure)}">${structure.toFixed(2)}</span>
                            <span class="stat-label">Structure</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value ${getScoreClass(refData)}">${refData.toFixed(2)}</span>
                            <span class="stat-label">Ref Data</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value ${missing > 0 ? "warning" : "neutral"}">${missing}</span>
                            <span class="stat-label">Missing</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value ${extra > 0 ? "warning" : "neutral"}">${extra}</span>
                            <span class="stat-label">Extra</span>
                        </div>
                    </div>
                `;
            }

            function renderGradeTable(rowGrades) {
                if (!rowGrades || rowGrades.length === 0) {
                    return '<div class="empty-state">No row grades available</div>';
                }

                // Get all unique column headers
                const columns = getUniqueColumns(rowGrades);
                if (columns.length === 0) {
                    return '<div class="empty-state">No cell grades available</div>';
                }

                let html =
                    '<div class="table-container"><table class="grade-table">';

                // Header row
                html += "<thead><tr>";
                html += '<th class="row-key-header">Row</th>';
                columns.forEach((col) => {
                    html += `<th>${escapeHtml(col)}</th>`;
                });
                html += "</tr></thead>";

                // Data rows
                html += "<tbody>";
                rowGrades.forEach((row) => {
                    html += "<tr>";

                    // Row key cell
                    html += `<td class="row-key-cell">
                        <div class="row-key-name">${escapeHtml(row.row_key || "Unknown")}</div>
                        <div class="row-key-meta">${(row.row_accuracy * 100).toFixed(0)}% acc</div>
                    </td>`;

                    // Cell grades
                    columns.forEach((col) => {
                        const cellGrade = findCellGrade(row.cell_grades, col);
                        if (cellGrade) {
                            html += renderGradeCell(cellGrade);
                        } else {
                            html +=
                                '<td><div class="grade-cell"><div class="empty-state" style="padding: 16px;">-</div></div></td>';
                        }
                    });

                    html += "</tr>";
                });
                html += "</tbody></table></div>";

                return html;
            }

            function getUniqueColumns(rowGrades) {
                const columns = new Set();
                rowGrades.forEach((row) => {
                    (row.cell_grades || []).forEach((cell) => {
                        if (cell.column_header) {
                            columns.add(cell.column_header);
                        }
                    });
                });
                return Array.from(columns);
            }

            function findCellGrade(cellGrades, columnHeader) {
                if (!cellGrades) return null;
                return cellGrades.find((c) => c.column_header === columnHeader);
            }

            function renderGradeCell(cell) {
                const eval_ = cell.evaluation || {};
                const annotation = eval_.annotation || "UNKNOWN";
                const badgeClass = getAnnotationBadgeClass(annotation);
                const cellClass = getCellClass(annotation);
                const subtype = eval_.subtype || "";
                const rationale = eval_.rationale || "No rationale provided";

                return `
                    <td>
                        <div class="grade-cell ${cellClass}">
                            <div class="grade-cell-badge">
                                <div class="tooltip-container">
                                    <span class="badge ${badgeClass}">${escapeHtml(annotation)}</span>
                                    <div class="tooltip">
                                        <div class="tooltip-subtype">${escapeHtml(subtype)}</div>
                                        <div class="tooltip-rationale">${escapeHtml(rationale)}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="grade-cell-values">
                                <div class="grade-cell-predicted">
                                    <div class="grade-cell-label">Pred</div>
                                    <div class="grade-cell-value">${escapeHtml(cell.predicted_value || "-")}</div>
                                </div>
                                <div class="grade-cell-gt">
                                    <div class="grade-cell-label">GT</div>
                                    <div class="grade-cell-value">${escapeHtml(cell.ground_truth_value || "-")}</div>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
            }

            function renderMissingExtraRows(missing, extra) {
                if (missing.length === 0 && extra.length === 0) return "";

                let html = '<div class="row-list-section">';

                if (missing.length > 0) {
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div class="detail-label" style="margin-bottom: 8px;">Missing Rows (in GT but not in prediction)</div>
                            <div class="row-list">
                                ${missing.map((r) => `<span class="row-list-item missing">${escapeHtml(r)}</span>`).join("")}
                            </div>
                        </div>
                    `;
                }

                if (extra.length > 0) {
                    html += `
                        <div>
                            <div class="detail-label" style="margin-bottom: 8px;">Extra Rows (in prediction but not in GT)</div>
                            <div class="row-list">
                                ${extra.map((r) => `<span class="row-list-item extra">${escapeHtml(r)}</span>`).join("")}
                            </div>
                        </div>
                    `;
                }

                html += "</div>";
                return html;
            }

            function renderEvaluationOutputs(outputs, emptyMessage) {
                if (!outputs || outputs.length === 0) {
                    return `<div class="empty-state">${escapeHtml(emptyMessage)}</div>`;
                }

                return outputs
                    .map((output, idx) => renderEvaluationOutput(output, idx))
                    .join("");
            }

            function renderEvaluationOutput(output, idx) {
                const annotation = output.annotation || "UNKNOWN";
                const badgeClass = getAnnotationBadgeClass(annotation);
                const subtype = output.subtype || "";
                const rationale = output.rationale || "";

                return `
                    <div class="eval-output" data-eval-idx="${idx}">
                        <div class="eval-output-header" onclick="toggleEvalOutput(this)">
                            <span class="eval-output-toggle">&#9660;</span>
                            <span class="badge ${badgeClass}">${escapeHtml(annotation)}</span>
                            <span style="font-size: 12px; color: var(--text-muted); font-family: monospace;">${escapeHtml(subtype)}</span>
                        </div>
                        <div class="eval-output-content">
                            <div class="detail-label">Rationale</div>
                            <div class="detail-value rationale">${escapeHtml(rationale)}</div>
                        </div>
                    </div>
                `;
            }

            function renderJsonFallback(data) {
                // Configure renderjson
                renderjson.set_show_to_level(1);
                renderjson.set_icons("+", "-");

                const containerId = `json-container-${Math.random().toString(36).substr(2, 9)}`;

                // We need to render after DOM is ready, so use setTimeout
                setTimeout(() => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.appendChild(renderjson(data));
                    }
                }, 0);

                return `
                    <div class="panel">
                        <div class="panel-header">
                            <span>Output (JSON)</span>
                            <span class="badge" style="background-color: var(--text-muted); color: #000;">Fallback</span>
                        </div>
                        <div class="panel-content">
                            <div class="json-fallback" id="${containerId}"></div>
                        </div>
                    </div>
                `;
            }

            // Helper functions
            function getAnnotationBadgeClass(annotation) {
                const mapping = {
                    CORRECT: "badge-correct",
                    FORMAT: "badge-format",
                    USEFUL: "badge-useful",
                    NOT_FOUND: "badge-not-found",
                    MISSING: "badge-missing",
                    NOT_MATCH: "badge-not-match",
                    REFERENCE_QUALITY: "badge-reference-quality",
                    TABLE_CONSISTENT_ISSUE: "badge-table-issue",
                };
                return mapping[annotation] || "badge-not-match";
            }

            function getCellClass(annotation) {
                const mapping = {
                    CORRECT: "cell-correct",
                    FORMAT: "cell-format",
                    USEFUL: "cell-useful",
                    NOT_FOUND: "cell-not-found",
                    MISSING: "cell-missing",
                    NOT_MATCH: "cell-not-match",
                    REFERENCE_QUALITY: "cell-reference-quality",
                    TABLE_CONSISTENT_ISSUE: "cell-table-issue",
                };
                return mapping[annotation] || "cell-not-match";
            }

            function getScoreClass(score) {
                if (score >= 0.9) return "good";
                if (score >= 0.7) return "warning";
                return "bad";
            }

            function escapeHtml(text) {
                if (text === null || text === undefined) return "";
                const div = document.createElement("div");
                div.textContent = String(text);
                return div.innerHTML;
            }

            function toggleEvalOutput(header) {
                const output = header.closest(".eval-output");
                output.classList.toggle("expanded");
            }

            function attachEventListeners() {
                document.querySelectorAll(".tab").forEach((tab) => {
                    tab.addEventListener("click", function () {
                        const tabName = this.getAttribute("data-tab");
                        const panel = this.closest(".panel");

                        panel
                            .querySelectorAll(".tab")
                            .forEach((t) => t.classList.remove("active"));
                        this.classList.add("active");

                        panel
                            .querySelectorAll(".tab-content")
                            .forEach((c) => c.classList.remove("active"));
                        panel
                            .querySelector(`[data-tab-content="${tabName}"]`)
                            .classList.add("active");
                    });
                });
            }
        </script>
    </body>
</html>
